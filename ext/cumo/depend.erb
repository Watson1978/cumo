TAGSRC = \
 ../../ruby/include/ruby/*.h \
 ../../ruby/*.c \
 narray/*.h \
 narray/types/*.h \
 narray/*.c \
 narray/types/*.c \
 narray/types/*.cu

tags : TAGS
TAGS : $(TAGSRC)
	etags $(TAGSRC)

doc :
	yard doc narray/*.c narray/types/*.c

run :
	ruby -I. ./test.rb

gdb :
	gdb -x run.gdb --quiet --args $(shell ruby -e 'puts RbConfig::CONFIG["bindir"]')/ruby -I. ./test.rb

C_TMPL = <%=Dir.glob("narray/gen/tmpl*/*.c").join(" ")%>
CU_TMPL = <%=Dir.glob("narray/gen/tmpl*/*.cu").join(" ")%>

COGEN = narray/gen/cogen.rb
CUGEN = narray/gen/cugen.rb
C_DEPENDS = $(C_TMPL) narray/gen/*.rb
CU_DEPENDS = $(CU_TMPL) narray/gen/*.rb

<%
type_c = []
type_rb = Dir.glob("narray/gen/def/*.rb")
type_rb.each do |s|
  type_c << c = "narray/types/"+File.basename(s,".rb")+".c"
%>
<%=c%>: <%=s%> $(C_DEPENDS)
	$(MAKEDIRS) $(@D) types
	ruby $(COGEN) -l -o $@ <%=s%>
<% end %>

<%
type_cu = []
type_rb = Dir.glob("narray/gen/def/*.rb")
type_rb.each do |s|
  type_cu << cu = "narray/types/"+File.basename(s,".rb")+"_kernel.cu"
%>
<%=cu%>: <%=s%> $(CU_DEPENDS)
	$(MAKEDIRS) $(@D) types
	ruby $(CUGEN) -l -o $@ <%=s%>
<% end %>

src : <%= type_cu.join(" ") %> <%= type_c.join(" ") %>

CLEANOBJS = *.o */*.o *.bak narray/types/*.c narray/types/*.cu
