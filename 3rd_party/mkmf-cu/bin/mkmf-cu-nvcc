#!/usr/bin/env ruby
require "open3"
require_relative "../lib/mkmf-cu/opt"
require_relative "../lib/mkmf-cu/colorize"

argv = ARGV.map{|e| e.dup }

def run!(*args)
  puts MkmfCu.colorize(:green, args.join(' '))
  exit system(*args)
end

src_file = argv.last
unless src_file.end_with?('.cu')
  ext = argv.shift
  if ext.end_with?('=cxx')
    run!(RbConfig::CONFIG["CXX"], *argv)
  elsif ext.end_with?('=c')
    run!(RbConfig::CONFIG["CC"], *argv)
  else
    raise 'something wrong'
  end
end

opt, opt_h = build_optparser()

puts '[given command line options]: ' + ARGV.join(' ')
parse_ill_short(argv, opt_h)
parse_ill_short_with_arg(argv, opt_h)

argv = opt.parse(argv)

if opt_h["-c"].size > 0
  s = generate_compiling_command_line(opt_h)
elsif opt_h['-dynamic'].size > 0 or opt_h['-shared'].size > 0
  s = generate_linking_command_line(argv, opt_h)
else
  raise
end

s << " -arch=sm_35" # TODO(sonots): How to add this nicely?
s << " -std=c++14" # TODO(sonots): How to add this nicely?
run!("nvcc" << s)
